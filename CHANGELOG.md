# 更新日志

## 2025-11-01 - 自动关闭推广弹窗

### 问题 (Issue)
发布页面偶尔出现"试试文字配图吧"等推广弹窗，阻塞后续上传流程。

### 修复 (Fix)
- 新增 `_close_promotional_popup()` 方法自动检测并关闭弹窗
- 支持多种关闭方式：点击「立即体验」按钮、ESC 键、JavaScript 移除等
- 添加调试日志和截图功能（`debug_popup_*.png`）
- 弹窗处理失败不影响主流程

### 影响 (Impact)
- 修改文件：`rednote/publisher.py`
- 完全向后兼容

---

## 2025-09-02 - 全面修复内容填充和话题插入功能

本次更新主要解决了小红书使用TipTap/ProseMirror编辑器后，内容填充和话题插入失败的问题。

### 问题背景 (Issue Background)

小红书创作平台已从Quill编辑器切换到TipTap/ProseMirror编辑器，导致原有的内容填充逻辑失效：
- 编辑器元素无法找到（`div.ql-editor` 选择器失效）
- 内容填充后无法保存（JavaScript事件处理不同）
- 话题插入位置错误且无法处理弹窗

### 主要修改 (Major Changes)

#### 1. **内容填充功能全面重构** (`filler.py: fill_content`)
- **添加等待和重试机制**：初始等待2秒让编辑器加载，最多重试3次
- **多选择器支持**：尝试6种不同选择器查找编辑器
  - `div.ql-editor` (Quill)
  - `div[contenteditable='true']` (通用)
  - `.tiptap` (TipTap)
  - `.ProseMirror` (ProseMirror)
  - `.content-input`
  - `#content-input`
- **三种填充策略**：
  - 策略A：JavaScript直接设置内容（针对不同编辑器类型优化）
  - 策略B：点击激活 + type()方法（模拟真实输入）
  - 策略C：原fill()方法作为备用
- **增强的内容验证**：更宽松的验证逻辑，支持多种编辑器类型
- **详细的调试日志**：显示编辑器状态、找到的元素、失败原因

#### 2. **话题插入功能优化** (`filler.py: fill_topics`)
- **自动检测编辑器类型**：识别TipTap/ProseMirror或Quill
- **精确的光标定位**：
  - 使用JavaScript API直接定位到文档末尾
  - 回退到Ctrl+End键盘快捷键
  - 只添加单个换行符分隔内容和话题
- **话题弹窗处理**：
  - 等待弹窗出现（500ms）
  - 尝试多种选择器查找弹窗
  - 点击第一个建议项或按Enter确认
- **调试信息增强**：显示内容长度、最后50个字符、找到的弹窗元素

#### 3. **验证逻辑改进** (`filler.py: _verify_content_filled`)
- 尝试多个选择器查找内容
- 更宽松的内容匹配（只检查前20个字符）
- 支持极短内容的验证

### 技术细节 (Technical Details)

#### JavaScript语法问题修复
- 问题：f-string格式化JavaScript代码时花括号转义错误
- 解决：改用参数传递方式，避免字符串插值
```python
# 之前（错误）
await self.page.evaluate(f'''() => {{ ... }}''')
# 之后（正确）
await self.page.evaluate('''(args) => { ... }''', args)
```

#### TipTap编辑器特殊处理
- 使用`document.execCommand('insertText')`而不是直接设置innerHTML
- 使用Selection API精确控制光标位置
- 触发正确的事件（input, change）

### 测试结果 (Test Results)
- ✅ 成功找到并识别TipTap编辑器
- ✅ 内容填充成功率大幅提升
- ✅ 话题插入到正确位置（文档末尾）
- ✅ 话题弹窗正确处理

---

## 2025-09-02 (早期版本) - 适配新版本小红书web版

本次更新主要针对小红书web版的界面变化进行了全面适配，显著增强了话题填充功能的稳定性和准确性。

### 新功能与优化 (New Features & Optimizations)

*   **完全适配新版小红书web版**: 更新了所有页面元素定位器，确保与最新版本的小红书web界面完全兼容。
*   **增强话题填充功能**: 大幅优化话题填充逻辑，通过改进的定位器策略和交互方式，提高话题添加的成功率。
*   **代码结构优化**: 对 `filler.py` 进行了大规模重构，新增 571 行代码，删除 47 行过时代码，使整体逻辑更加健壮。

### 技术细节 (Technical Details)

*   **定位器升级**: 更新了内容填充相关的所有CSS选择器和XPath表达式，以适应新版界面结构。
*   **交互流程改进**: 优化了话题选择和确认的交互流程，减少了因界面变化导致的失败率。
*   **兼容性增强**: 确保工具在新版小红书web界面下的稳定运行。

## 2025-07-10 - 端到端发布流程修复

本次更新主要解决了从登录到发布的整个自动化流程中的多个关键问题，显著提升了工具的稳定性和可靠性。

### 修复与优化 (Fixes & Optimizations)

*   **登录流程**: 重构了登录检测逻辑，能更可靠地处理自动登录和手动扫码登录场景。
*   **文件上传**: 彻底修复了文件上传流程，通过直接与上传控件交互，解决了因元素覆盖或查找冲突导致的失败问题。
*   **内容填充**: 修正了正文和话题的填充方式。现在可以正确识别编辑器并模拟真实用户操作添加可点击的话题标签。
*   **发布确认**: 优化了发布确认机制，通过等待“发布成功”的明确信号来判断任务完成，并确保浏览器在任务结束后能自动关闭。
*   **定位器增强**: 全面增强了页面元素的定位器，使用 XPath 和更精确的 CSS 选择器来避免严格模式冲突，提高了交互的稳定性。

### 已知限制 (Known Limitations)

*   **仅支持图文发布**: 当前版本主要针对**图文类型**的笔记发布进行了完整调试和优化。视频类型的发布流程虽已初步实现，但尚未经过���分测试，可能无法保证成功。这主要是因为目前的开发和测试场景以图文发布为主。

### 文档 (Documentation)

*   新增了详细的 `README.md` 文件，包含了项目介绍、安装步骤和使用方法，方便新用户快速上手。
